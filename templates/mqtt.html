<style>
.mono {
	font-family:monospace;
	font-size:110%;
	font-weight:bold;
	color:green;

}
#overlay 
{
  display: none !important;
}
</style>

<TMPL_IF FORM_SETTINGS>
	<!-- Form SETTINGS -->
	<form id="form" onsubmit="return false;">

	<div class="wide">MQTT to Miniserver</div>
	<br>

	<div data-role="fieldcontain">
		<fieldset data-role="controlgroup">
			<legend>Type sending the data to Miniserver</legend>
			<input type="checkbox" name="Main.use_http" id="Main.use_http">
			<label for="Main.use_http">Set virtual inputs via HTTP webservice (recommended)</label>
			<input type="checkbox" name="Main.use_udp" id="Main.use_udp">
			<label for="Main.use_udp">Send data via UDP</label>
			<p class="hint">See the Wiki for details how to configure your inputs on your Miniserver.</p>
		</fieldset>
		
	<div>

	<div data-role="fieldcontain">
		<!-- <label for="Main.msno">Miniserver to relay to</label> -->
		<TMPL_VAR mslist_select_html>
	</div>

	<div data-role="fieldcontain">
		<label for="Main.udpport">Miniserver UDP port</label>
		<input name="Main.udpport" id="Main.udpport" type="text" />
		<p class="hint">Default UDP port is <span class="mono">11883</span>. If UDP is enabled, data <i>from the broker</i> are sent to this udp port on the Miniserver.</p>
	</div>

	<div data-role="fieldcontain">
		<fieldset data-role="controlgroup">
			<legend>Data transformations</legend>
			<input type="checkbox" name="Main.convert_booleans" id="Main.convert_booleans">
			<label for="Main.convert_booleans">Convert booleans to 1 and 0</label>
			<input type="checkbox" name="Main.expand_json" id="Main.expand_json">
			<label for="Main.expand_json">Expand JSON data</label>
		</fieldset>
	</div>

	<br>
	<div class="wide">Miniserver to MQTT</div>
	<br>

	<div data-role="fieldcontain">
		<label for="Main.udpinport">Gateway UDP in-port</label>
		<input name="Main.udpinport" id="Main.udpinport" type="text" />
		<p class="hint">Default UDP IN-port on LoxBerry is <span class="mono">11884</span>. Publish data <i>from the Miniserver</i> to this udp port.</p>
	</div>

	<br>
	<div class="wide">MQTT Broker</div>
	<br>
	<fieldset data-role="controlgroup">
		<legend>Use local Mosquitto broker</legend>
		<input type="checkbox" name="Main.enable_mosquitto" id="Main.enable_mosquitto">
		<label for="Main.enable_mosquitto">Use the local Mosquitto MQTT broker (default: enabled)</label>
		<p class="hint">If <i>enabled</i>, changes of the credentials below will <u>change</u> your local MQTT broker credentials. If <i>disabled</i>, it only changes the credentials used by the Gateway to connect to your broker.</p>
	</fieldset>

	<div data-role="fieldcontain">
		<label for="Main.brokeraddress">MQTT Broker address</label>
		<input name="Main.brokeraddress" id="Main.brokeraddress" type="text" />
		<p class="hint">Default is <span class="mono">localhost:1883</span> for the local Mosquitto installation. Experienced users may use a remote MQTT broker. Configure MQTT devices to connect to the real hostname (usually loxberry) and port.</p>
	</div>

	<div id="securepin_block" style="background-color:lightyellow;">
		<div style="display:flex;justify-content:center;align-content:space-around;">
		<!-- <div id="securepin_block"> -->
			<div style="flex-grow:3; padding: 5px 5px 5px 5px;">
				<!-- <div class="ui-field-contain"> -->
					<label for="securepin" style="color:red;">To show your broker credentials, enter your LoxBerry SecurePIN</label>
				<!-- </div> -->
			</div>
			<div style="flex-grow:1;padding: 5px 5px 5px 5px;">
				<input name="securepin" id="securepin" type="text">
			</div>
			<div style="flex-grow:1; padding: 5px 5px 5px 5px;">
				<button class="ui-btn ui-btn-icon-right ui-corner-all" id="check_securepin" data-inline="true">Check PIN</button>
			</div>
		</div>
		<div class="hint" id="check_hint" style="display:flex; flex-flow:wrap; padding: 5px 5px 5px 5px;">If a cyber attacker could find out your LoxBerry web password, this is an additional 2-phase protection to not spy credentials of your MQTT broker.<br><b>After pressing Check PIN, the password <i>directly</i> is shown (not hidden by ***).</b></div>
		</div>
	</div>
	
	<div id="credentials_block" style="display:none">
		
		<div data-role="fieldcontain">
			<label for="Credentials.brokeruser">MQTT Broker username</label>
			<input name="Credentials.brokeruser" id="Credentials.brokeruser" type="text" />
			<p class="hint">Default is <span class="mono">loxberry</span> for the local Mosquitto installation. <i>Emptying user and password will disable authentication.</i></p>
		</div>

		<div data-role="fieldcontain">
			<label for="Credentials.brokerpass">MQTT Broker password</label>
			<input name="Credentials.brokerpass" id="Credentials.brokerpass" type="text" />
			<!-- <p class="hint">Use a safe password! <b>Double</b>click the dice to generate a new password: <img ondblclick="pwRandomize()" src="images/dice_30_30.png"></p> -->
			<p class="hint">Use a safe password! Click the dice to open a funny password generator: <a href="https://www.dinopass.com/" target="_blank"><img src="images/dice_30_30.png" alt="Dice"></a></p>
		</div>
		
		<div data-role="fieldcontain" id="brokerpsk_block" style="display:none">
			<label for="Credentials.brokerpsk">Broker Pre-Shared Key (TLS-PSK)</label>
			<input name="Credentials.brokerpsk" id="Credentials.brokerpsk" type="text" readonly="readonly" />
			<!-- <p class="hint">Use a safe password! <b>Double</b>click the dice to generate a new password: <img ondblclick="pwRandomize()" src="images/dice_30_30.png"></p> -->
			<p class="hint">This is the pre-shared key for TLS encryption. To use an encrypted broker connection on your devices, use user, pass and psk, connecting to port 8883. To keep the key save, you cannot change the psk here.</p>
		</div>
		
		
		<p>If you <b>change</b> user and/or password on the local installation, you have to <b>reconfigure</b> all connected devices too. Start with a safe password to avoid security issues. Store user and pass a second time on a secure place.</p>  
	
	</div>
	</form>
	<!-- /Form SETTINGS -->
</TMPL_IF>

<TMPL_IF FORM_SUBSCRIPTIONS>
	<!-- Form SUBSCRIPTIONS -->
	<form id="form" onsubmit="return false;">

	<div class="wide">MQTT Subscriptions</div>
	<p>Subscriptions are the topics of MQTT devices that are relayed to the Miniserver. A # sign symbols a joker in MQTT. Use exactly the topic(s) provided by the device vendor.</p> 
	<p style="font-size:80%"><i>Advanced feature:</i> Send specific subscriptions to specific Miniservers - after the subscription, use a pipe | symbol followed by a list of Miniserver numbers (from the Miniserver widget), e.g. <span class="mono">shellies/#|2</span> or <span class="mono">shellies/#|2,3</span>. Without pipe, the default Miniserver from the <i>Settings</i> page is used.</p>
<!-- 	<div data-role="fieldcontain"> -->
<!--		<label for="subscriptions">MQTT subscriptions <p class="hint">One subscription topic per line. For Shelly devices, use <span class="mono">shellies/#</span></p>
		<p id="invalidTopics" class="hint" style="color:red"></p>
		
		</label> -->
	<style>
	.notes {
    background-attachment: local;
    background-image:
        linear-gradient(to right, white 8px, transparent 10px),
        linear-gradient(to left, white 8px, transparent 10px),
        repeating-linear-gradient(white, white 23px, #ddd 23px, #ddd 24px, white 24px);
    line-height: 24px !important;
    padding: 4px 10px !important; 
	}
	</style>


	<div class="ui-grid-b">
	<div class="ui-block-a" style="width:20%;min-width:200px;max-width:35%">
		<p class="hint">One subscription topic per line. For Shelly devices, use <span class="mono">shellies/#</span></p>
		<p id="invalidTopics" class="hint" style="color:red"></p>
	</div>
	<div class="ui-block-b" style="width:50%;min-width:20%;">
		<textarea name="subscriptions" id="subscriptions" rows="20" data-autogrow="false" class="notes"></textarea>
	</div>
	</div>
<!--	</div> -->
	</form>
	
	
	<div data-role='collapsible' id='coll_extsubscriptions' data-content-theme='true' data-collapsed='true' data-collapsed-icon='carat-d' data-expanded-icon='carat-u' data-iconpos='right' style="display:none">
		<h2 class='ui-bar ui-bar-a ui-corner-all'>Subscriptions defined by other plugins</h2>
		<div id="extplugin_subscriptions" style="display:flex;flex-wrap:wrap;justify-content:space-evenly;align-items:flex-start;align-content:flex-start;background-color:lightgray;">
		</div>
	</div>
	
	<!-- /Form SUBSCRIPTIONS -->
	
	
</TMPL_IF>

<TMPL_IF FORM_CONVERSIONS>
	<!-- Form CONVERSIONS -->
	<form id="form" onsubmit="return false;">

	<div class="wide">Text-to-Value conversions</div>
	<p>MQTT devices often are sending strings that Loxone unfortunately cannot handle. In this field you can create text-to-value conversions. You can assign values to incoming strings, that values are sent to the Miniserver, and can be evaluated e.g. with a Status block.</p> 
	<p>Booleans (on, off etc.) are already converted, if you have 'Boolean conversion' enabled.</p>
	<div data-role="fieldcontain">
		<label for="conversions">Text-to-Value conversion <p class="hint">One conversion per line. Use <span class="mono">Text=Value</span></p></label>
		<textarea name="conversions" id="conversions" rows="20" data-autogrow="false"></textarea>
	</div>
	</form>

	<div data-role='collapsible' id='coll_extconversions' data-content-theme='true' data-collapsed='true' data-collapsed-icon='carat-d' data-expanded-icon='carat-u' data-iconpos='right' style="display:none">
		<h2 class='ui-bar ui-bar-a ui-corner-all'>Conversions defined by other plugins</h2>
		<div id="extplugin_conversions" style="display:flex;flex-wrap:wrap;justify-content:space-evenly;align-items:flex-start;align-content:flex-start;background-color:lightgray;">
		</div>
	</div>
	
	
	<!-- /Form CONVERSIONS -->
</TMPL_IF>


<TMPL_IF FORM_TOPICS>
	<!-- Form TOPICS (Incoming Overview) -->
	<style>
	.topics_table {
		/* font-family: "Trebuchet MS", Arial, Helvetica, sans-serif; */
		border-collapse: collapse;
		width: 100%;
	}

	.topics_table td, .topics_table th {
		border: 1px solid #ddd;
		padding: 8px;
	}

	.topics_table tr:nth-child(even){background-color: #f2f2f2;}

	.topics_table tr:hover {background-color: #ddd;}

	.topics_table th {
		padding-top: 12px;
		padding-bottom: 12px;
		text-align: left;
		background-color: #6dac20;
		color: white;
		text-shadow: 1px 1px #333333;
		
	}
	</style>
	
	<div class="wide">Last transmissions to Miniserver</div>
	<p>This page lists the transmissions via the MQTT Gateway to the Miniserver in the last 24 hours. It is refreshed <i>automatically on-the-fly</i> (as long as you have text selected, updating stops).<p>
	<p>You can copy and paste the 'Virtual Input' names for HTTP transmissions, or create command recognitions from the UDP messages.</p>
	
	<input type="checkbox" name="topics_show_advanced" id="topics_show_advanced" data-mini="true">
	<label for="topics_show_advanced">Show advanced table information</label>
	
	<div data-role='collapsible' id='coll_mqtthttp' data-content-theme='true' data-collapsed='true' data-collapsed-icon='carat-d' data-expanded-icon='carat-u' data-iconpos='right'>
		<h2 class='ui-bar ui-bar-a ui-corner-all' id='head_mqtthttp'>HTTP Virtual Inputs <span style='font-size:80%;'>(<span id="http_count">0</span> entries)<span id='head_mqtthttp_permissionErrors' style='display:none;font-size:80%;'>&nbsp;&nbsp;<img style="position:relative;left:15px;top:3px;" src="images/icon-locked.png">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;There are entries with access denied</span></h2>
		<div id="generated_http_table">
		</div>
		<!-- <TMPL_VAR http_table> -->
	</div>
	
	<div data-role='collapsible' id='coll_mqttudp' data-content-theme='true' data-collapsed='true' data-collapsed-icon='carat-d' data-expanded-icon='carat-u' data-iconpos='right'>
		<h2 class='ui-bar ui-bar-a ui-corner-all' id='head_mqttudp'>UDP Transmissions <span style='font-size:80%;'>(<span id="udp_count">0</span> entries)</span></h2>
		<div id="generated_udp_table">
		</div>
		<!-- <TMPL_VAR udp_table> -->
	</div>
	<br>
	
	<!-- Donation -->
	<div data-role='collapsible' id='coll_donate' data-content-theme='true' data-collapsed='true' data-collapsed-icon='carat-d' data-expanded-icon='carat-u' data-iconpos='right'>
		<h2 class='ui-bar ui-bar-a ui-corner-all' id='head_donate'>Donate for test equipment</h2>
		<TMPL_VAR donate>
		<div style="margin:auto;text-align:center;">
		<br>
		<a href="https://paypal.me/christianfenzl" target="_blank"><img src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" alt="Donate with PayPal.me" /></a>
			
		</div>
		<br>
		<div style="display:flex;justify-content:center;align-content:space-around;">
			<div style="padding: 10px 10px 10px 10px;">
				<fieldset data-role="controlgroup">
					<input type="checkbox" name="Main.donation_remove" id="Main.donation_remove">
					<label for="Main.donation_remove"><TMPL_VAR donate_done_remove></label>
				</fieldset>
			</div>
			<div style="padding: 10px 10px 10px 10px;">
				<button class="ui-btn ui-btn-icon-right ui-corner-all" id="saveapply" data-inline="true">Save</button>
			</div>
		</div>
		<!-- <button id="Main.remove_donate" data-mini="true"><TMPL_VAR donate_done_remove></button> -->
	</div>
	<br>
	
	<div style="display:flex;align-items:center;justify-content:center;">
		<!-- Clear broker database -->
		<button class="ui-btn ui-btn-icon-right" id="purgemosquittodb" data-inline="true" style="display:none">Clear broker database</button>
		<button class="ui-btn ui-btn-icon-right" id="reconnect" data-inline="true">Retransmit all data (for testing)</button>
	</div>
	
	<script>
		
		var updateTopicsRunning = 0;
		var currentElementCount = 0;
		var refreshInterval = 1000;
		var intervalID;
		
		$( document ).ready(function() {
			restoreWindow();
			$(".ui-collapsible").on("collapsiblecollapse", function(event, ui) {
				// console.log("Collaps", $(this).attr('id'));
				storeWindow($(this).attr('id'), "collapse");
			});
			$(".ui-collapsible").on("collapsibleexpand", function(event, ui) {
				// console.log("Expand", $(this).attr('id'));
				curr_coll = this;
				storeWindow($(this).attr('id'), "expand");
				$.each( $(".ui-collapsible"), function ( index, value ) {
					if( this !== curr_coll ) {
						// console.log("Close ", $(this).attr('id'));
						$(this).collapsible( "collapse" );
					}
				});
			});
			// Update date from http and udp table
			http_table_skel();
			udp_table_skel();
			updateTopics();
		});

		function storeWindow (name, pos) 
		{
			sessionStorage.setItem("coll_"+name, pos);
		}

		function restoreWindow() 
		{
			$.each( $(".ui-collapsible"), function ( index, value ) {
				var pos = sessionStorage.getItem("coll_"+$(value).attr('id'));
				if(pos === "expand" || pos === "collapse") {
					$(value).collapsible( pos );
				} else {
					sessionStorage.removeItem("coll_"+$(value).attr('id'));
				}
				// console.log($(value).attr('id'), pos);	
			}
			);
		}
	
		function updateTopics() {
			// console.log("Update topics");
			// Serialize requests
			if (getSelectedText()) {
				// console.log("Text is selected");
				return; }
			if (updateTopicsRunning) return;
			
			var udpinport = 0;
			if (cfg) udpinport = cfg.Main.udpinport;
			
			updateTopicsRunning = 1;
			
			// The refresh interval is dependent to the number of elements
			newRefreshInterval = calcInterval();
			// console.log("CalcInterval:", newRefreshInterval, "intervalID:", intervalID);
			if ( intervalID === undefined ) {
				// console.log("Refresh interval set to", refreshInterval);
				intervalID = setInterval(updateTopics, refreshInterval);
			} else if ( newRefreshInterval != refreshInterval ) {
				// console.log("Old refreshInterval", refreshInterval, "New refreshInterval", newRefreshInterval);
				// console.log("Refreh interval updated to", newRefreshInterval);
				refreshInterval = newRefreshInterval;
				clearInterval(intervalID);
				intervalID = setInterval(updateTopics, refreshInterval);
			}
			
			// console.log(logtime(), "RELAYED_TOPICS START Request");
			$.post( 'ajax_php.php', {
				ajax: 'relayed_topics',
				udpinport: udpinport })
			.done(function(resp) {
				// console.log(logtime(), "RELAYED_TOPICS DONE Request");
			
				// console.log( "ajax_post", "success", resp );
				if (getSelectedText()) {
					// console.log("Text is selected");
					return; 
				}
				
				// Prefill non-existing elements in config
				if ( !("resetAfterSend" in resp ) )
					resp[ "resetAfterSend" ] = null;
				if ( !("Noncached" in resp ) )
					resp[ "Noncached" ] = null;
				if ( !("doNotForward" in resp ) )
					resp[ "doNotForward" ] = null;
				
				
				// console.log(logtime(), "RELAYED_TOPICS Generate_http_table");
				generate_http_table(resp);
				// console.log(logtime(), "RELAYED_TOPICS Generate_udp_table");
				generate_udp_table(resp);
				// console.log(logtime(), "RELAYED_TOPICS Bind buttons");
				
				$(".disablecache").bind( "change", function(event, ui) {
					checkbox_disablecache(event);
				});
				$(".resetAfterSend").bind( "change", function(event, ui) {
					checkbox_resetAfterSend(event);
				});
				$(".doNotForward").bind( "change", function(event, ui) {
					checkbox_doNotForward(event);
				});
				
				// console.log(logtime(), "RELAYED_TOPICS FINISHED");
				
		  })
		  .fail(function(resp) {
				console.log( "ajax_post", "failed", resp );
		  })
		  .always(function(resp) {
				// console.log( "ajax_post", "finished", resp );
				updateTopicsRunning = 0;
		  });
		}
		
		function http_table_skel() {
			var http_table;
			http_table = '<table class="topics_table" id="http_table" data-filter="true">\n';
			http_table+= '<thead>\n';
			http_table+= '<tr>\n';
			http_table+= '<th>Miniserver Virtual Input</th>\n';
			http_table+= '<th>Last value</th>\n';
			http_table+= '<th>Last arrived</th>\n';
			http_table+= '</tr>\n';
			http_table+= '</thead>\n';
			http_table+= '<tbody>\n';
			http_table+= '</tbody>\n';
			http_table+= '</table>\n';
			$('#generated_http_table').html(http_table).trigger('create');
		}
		
		function udp_table_skel() {
			var udp_table;
			udp_table = '<table class="topics_table" id="udp_table" data-filter="true">\n';
			udp_table+= '<thead>\n';
			udp_table+= '<tr>\n';
			udp_table+= '<th>Data</th>\n';
			udp_table+= '<th>Command Recognition</th>\n';
			udp_table+= '<th>Last arrived</th>\n';
			udp_table+= '</tr>\n';
			udp_table+= '</thead>\n';
			udp_table+= '<tbody>\n';
			udp_table+= '</tbody>\n';
			udp_table+= '</table>\n';
			$('#generated_udp_table').html(udp_table).trigger('create');
		}
		
		function generate_http_table(resp) {
			
			$("#http_count").text(resp.health_state.stats.http_relayedcount);
			//console.log( get( resp, 'health_state.stats.httpresp') );
			// $("#http_count_noaccess").text(" "+resp.health_state.stats.httpresp[500]);
			var http_noaccess = get( resp, 'health_state.stats.httpresp');
			http_noaccess = http_noaccess[500] != 'undefined' ? http_noaccess[500] : 0; 
			if( http_noaccess > 0 ) 
				$("#head_mqtthttp_permissionErrors").show();
			else
				$("#head_mqtthttp_permissionErrors").hide();
			
			if ( $("#coll_mqtthttp").hasClass('ui-collapsible-collapsed') ) {
				return;
			}
			
			currentElementCount = http_count;
			
			var date_options = { day: '2-digit', month: '2-digit' };
			$("#http_table > tbody").empty();
			
			var http_row;
			
			topics_show_advanced = $("#topics_show_advanced").prop('checked');
			
			Object.entries(resp.http).map(([topic, content]) => {
				//console.log(resp);
				
				var d = new Date(content.timestamp*1000); 
				http_row+= '<tr id='+topic+'>\n';
				http_row+= '<td>';
				
				if( typeof resp.http[topic].toMS != 'undefined' ) {
					toMSarr = resp.http[topic].toMS;
					var toMShighest = 0;
					var httpSubmitAdvTabInfRow = "";
					for( i in toMSarr ) {
						// console.log( topic, i, toMSarr[i].code );
						if( toMSarr[i].code > toMShighest )
							toMShighest = toMSarr[i].code;
					
						switch( toMSarr[i].code ) {
							case '404': 
								httpSubmitIcon = 'icon-notfound.png'; httpSubmitText = 'MS'+i+': HTTP 404 Input not available';
								break;
							case '500': 
								httpSubmitIcon = 'icon-locked.png'; httpSubmitText = 'MS'+i+': HTTP 500 Possibly permission denied'; 
								break;
							case '200':
								httpSubmitIcon = 'icon-check.png'; httpSubmitText = 'MS'+i+': HTTP 200 Value submitted'; 
								break;
							default: 
								httpSubmitIcon = 'icon-question.png'; httpSubmitText = 'Not sent so far (cache)'; 
						}
						
						httpSubmitTime = new Date(toMSarr[i].lastsent*1000);
						httpSubmitAdvTabInfRow += '<img src="images/'+httpSubmitIcon+'">&nbsp;'+httpSubmitText+' at '+httpSubmitTime.toLocaleString('de-DE', { hour:'numeric', minute:'numeric', hour12:false } )+'<br>';
					}
				switch( toMShighest ) {
						case '404': 
							httpSubmitIcon = 'icon-notfound.png'; httpSubmitText = 'HTTP 404 Input not available'; 
							break;
						case '500': 
							httpSubmitIcon = 'icon-locked.png'; httpSubmitText = 'HTTP 500 Possibly permission denied'; 
							break;
						case '200':
							httpSubmitIcon = 'icon-check.png'; httpSubmitText = 'HTTP 200 Value submitted'; 
							break;
						default: 
							httpSubmitIcon = 'icon-question.png'; httpSubmitText = 'Not sent so far (cache)'; 
					}
						
				} else {
					httpSubmitIcon = 'icon-question.png'; httpSubmitText = 'Not sent so far (cache)'; 
				}
							
				http_row+= '<img src="images/'+httpSubmitIcon+'" alt="'+httpSubmitText+'">&nbsp;';

				http_row+= topic;
				if( topics_show_advanced == true ) 
					http_row+= '<br><span style="font-size: 75%">(Topic <i>' + content.originaltopic + '</i>)</span>';
				http_row+= '</td>\n';
								
				var doNotForward;
				if( resp.doNotForward !== null && topic.replace(/\//g, "_") in resp.doNotForward ) {
					doNotForward = "checked";
				// console.log(topic, "is set to Do-Not-Forward");
				}
				http_row+= '<td>';
				if( doNotForward ) 
					http_row+= '<i><s style="text-shadow:none">';
				http_row+= content.message; 
				if( doNotForward ) 
					http_row+= '</s></i>';
				
				
				if( topics_show_advanced == true ) {
					
					var uncached;
					if( resp.Noncached !== null && topic.replace(/\//g, "_") in resp.Noncached ) {
						uncached = "checked";
					// console.log(topic, "is uncached");
					}
					http_row+= '<fieldset data-role="controlgroup" data-type="horizontal"><label><input type="checkbox" name="http_cache_disabled_'+topic+'" id="http_cache_disabled_'+topic+'"data-mini="true" class="disablecache" ' + uncached +'>Disable cache</label>';
				
					var resetAfterSend;
					if( resp.resetAfterSend !== null && topic.replace(/\//g, "_") in resp.resetAfterSend ) {
						resetAfterSend = "checked";
					// console.log(topic, "is reset after send");
					}
					http_row+= '<label><input type="checkbox" name="http_reset_after_send_'+topic+'" id="http_reset_after_send_'+topic+'"data-mini="true" class="resetAfterSend" ' + resetAfterSend +'>Reset after send</label>';
								
					http_row+= '<label><input type="checkbox" name="http_do_not_forward_'+topic+'" id="http_do_not_forward_'+topic+'"data-mini="true" class="doNotForward" ' + doNotForward +'>Do not forward</label></fieldset>';
				
				}
				http_row+= '</td>\n';
				
				http_row+= '<td>' + d.toLocaleDateString('hc', date_options) + ' ' + d.toLocaleTimeString();
				// http_row+= ' <a href="#" class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all ui-mini" data-topic="' + content.originaltopic +'" onclick="deleteTopic(\''+content.originaltopic+'\');"></a>';
				
				http_row+= '&nbsp;<a href="#" data-topic="' + content.originaltopic + '" onclick="deleteTopic(\''+content.originaltopic+'\');"><img src="images/icon-trash.png"></a>';
				
				if( topics_show_advanced == true ) {
					http_row+= '<br><span style="font-size:70%;">'+httpSubmitAdvTabInfRow+'</span>';
				}
				
				http_row+= '</div></td>\n';
				http_row+= '</tr>\n';
				
				
			});
			// $("#http_table").trigger('create');
			$("#http_table tbody").append(http_row);
			$("#http_table").filterable('refresh');
		}
		
		function generate_udp_table(resp) {
			
			$("#udp_count").text(resp.health_state.stats.udp_relayedcount);

			if ( $("#coll_mqttudp").hasClass('ui-collapsible-collapsed') ) {
				return;
			}
			
			currentElementCount = udp_count;
			
			var date_options = { day: '2-digit', month: '2-digit' };
			
			$("#udp_table > tbody").empty();
			
			var udp_row = undefined;
			
			Object.entries(resp.udp).map(([topic, content]) => {
				var d = new Date(content.timestamp*1000); 
				
				udp_row+= '<tr>\n';
				udp_row+= '<td>' + topic + '=' + content.message;
				
				if( $("#topics_show_advanced").prop('checked') == true ) 
					udp_row+= '<br><span style="font-size: 75%">(Topic <i>' + content.originaltopic + '</i>)</span>';
				udp_row+= '</td>\n';
				
				udp_row+= '<td>MQTT:\\i' + topic.replace("\\", "\\\\") + '=\\i\\v';
				
				if( $("#topics_show_advanced").prop('checked') == true ) {
					var uncached;
					if( resp.Noncached !== null && topic.replace(/\//g, "_") in resp.Noncached ) {
						uncached = "checked";
					// console.log(topic, "is uncached");
					}
					
					udp_row+= '<fieldset data-role="controlgroup" data-type="horizontal"><label><input type="checkbox" name="udp_cache_disabled_'+topic+'" id="udp_cache_disabled_'+topic+'"data-mini="true" class="disablecache" ' + uncached + '>Disable cache</label>';
				
					var resetAfterSend;
					if( resp.resetAfterSend !== null && topic.replace(/\//g, "_") in resp.resetAfterSend ) {
						resetAfterSend = "checked";
					// console.log(topic, "is reset after send");
					}
					udp_row+= '<label><input type="checkbox" name="udp_reset_after_send_'+topic+'" id="udp_reset_after_send_'+topic+'"data-mini="true" class="resetAfterSend" ' + resetAfterSend +'>Reset after send</label></fieldset>';
					
					var doNotForward;
					if( resp.doNotForward !== null && topic.replace(/\//g, "_") in resp.doNotForward ) {
						doNotForward = "checked";
					// console.log(topic, "is reset after send");
					}
					udp_row+= '<label><input type="checkbox" name="udp_do_not_forward_'+topic+'" id="udp_do_not_forward_'+topic+'"data-mini="true" class="doNotForward" ' + doNotForward +'>Do not forward</label></fieldset>';
		
				}
				udp_row+= '</td>'
				
				
				//udp_row+= '<td>' + content.message + '</td>\n';
				udp_row+= '<td>' + d.toLocaleDateString('hc', date_options) + ' ' + d.toLocaleTimeString();
				
				udp_row+= '&nbsp;<a href="#" data-topic="' + topic + '" onclick="deleteTopic(\''+topic+'\');"><img src="images/icon-trash.png"></a>';
				
				udp_row+= '</div></td>\n';
				udp_row+= '</tr>\n';
				
			});
						
			// $("#udp_table").trigger('create');
			$("#udp_table tbody").append(udp_row);
			$("#udp_table").filterable('refresh');
		}
		
		function getSelectedText() {
			var text = "";
				if (typeof window.getSelection != "undefined") {
					text = window.getSelection().toString();
				} else if (typeof document.selection != "undefined" && document.selection.type == "Text") {
				text = document.selection.createRange().text;
			}
        return text;
		}
    
		function deleteTopic(topic) {
			console.log("Delete", topic);
			console.log(event.toElement.dataset.topic);
			
			var udpinport = 0;
			if (cfg) udpinport = cfg.Main.udpinport;
			
			$.post( 'ajax_php.php', {
				ajax: 'retain',
				udpinport: udpinport,
				topic: topic })
			.done(function(resp) {
				console.log( "ajax_post", "success", resp );
				return; });
		
		
		} 
		
		function checkbox_disablecache(event) {
			var cachetarget;
			if (event.currentTarget.id.startsWith("http_cache_disabled_") == true)
				cachetarget = event.currentTarget.id.slice(20).replace(/\//g, '\_');
			else if (event.currentTarget.id.startsWith("udp_cache_disabled_") == true)
				cachetarget = event.currentTarget.id.slice(19).replace(/\//g, '\_');
			else
				return;
			
			// var cachetarget = event.currentTarget.id.replace(/\//g, '\_');
			var is_checked = event.currentTarget.checked;
			// console.log("checkbox_disablecache", cachetarget, "Checked", is_checked);
			
			$.post( 'index.cgi', {
				ajax: 'disablecache',
				disablecache: is_checked,
				topic: cachetarget })
			.done(function(resp) {
				// console.log( "ajax_post", "success", resp );
				return; 
			});
		};
		
		function checkbox_resetAfterSend(event) {
			var checkboxtarget;
			if (event.currentTarget.id.startsWith("http_reset_after_send_") == true)
				checkboxtarget = event.currentTarget.id.slice(22).replace(/\//g, '\_');
			else if (event.currentTarget.id.startsWith("udp_reset_after_send_") == true)
				checkboxtarget = event.currentTarget.id.slice(21).replace(/\//g, '\_');
			else
				return;
			
			// var checkboxtarget = event.currentTarget.id.replace(/\//g, '\_');
			var is_checked = event.currentTarget.checked;
			// console.log("checkbox_reset_after_send", checkboxtarget, "Checked", is_checked);
			
			$.post( 'index.cgi', {
				ajax: 'resetAfterSend',
				resetAfterSend: is_checked,
				topic: checkboxtarget })
			.done(function(resp) {
				// console.log( "ajax_post", "success", resp );
				return; 
			});
		};
		
		function checkbox_doNotForward(event) {
			var checkboxtarget;
			if (event.currentTarget.id.startsWith("http_do_not_forward_") == true)
				checkboxtarget = event.currentTarget.id.slice(20).replace(/\//g, '\_');
			else if (event.currentTarget.id.startsWith("udp_do_not_forward_") == true)
				checkboxtarget = event.currentTarget.id.slice(19).replace(/\//g, '\_');
			else
				return;
			
			// var checkboxtarget = event.currentTarget.id.replace(/\//g, '\_');
			var is_checked = event.currentTarget.checked;
			// console.log("checkbox_reset_after_send", checkboxtarget, "Checked", is_checked);
			
			$.post( 'index.cgi', {
				ajax: 'doNotForward',
				doNotForward: is_checked,
				topic: checkboxtarget })
			.done(function(resp) {
				// console.log( "ajax_post", "success", resp );
				return; 
			});
		};
		
		function calcInterval() {
			interval = 1000;
			if ( currentElementCount > 0 ) {
				interval = currentElementCount/200*1000;
				if ( interval < 1000 ) 
					interval = 1000;
				else if ( interval > 10000 ) 
					interval = 10000;
			}
			return interval;
		}
	
		function logtime() {
		  var d = new Date();
		  var sec = d.getSeconds();
		  var ms = d.getMilliseconds();
		  return(sec+"."+ms);
		}

	
	</script>

	<!-- /Form TOPICS -->
</TMPL_IF>




<TMPL_IF FORM_LOGS>
	<!-- Form LOGS -->
	<TMPL_VAR loglist_html>
	
	<div data-role='collapsible' id='coll_package_mosquitto' data-content-theme='true' data-collapsed='false' data-collapsed-icon='carat-d' data-expanded-icon='carat-u' data-iconpos='right'>
		<h2 class='ui-bar ui-bar-a ui-corner-all' id='package_mqttgateway_mosquitto'>Mosquitto Log</h2>
		<table style='width:100%; padding:8px; border:1px solid #ddd; border-collapse: collapse;'>
			<tr>
				<td>mosquitto.log</td>
				<td></td>
				<td><a data-role='button' href='/admin/system/tools/logfile.cgi?logfile=%2Fopt%2Floxberry%2Flog%2Fplugins%2Fmqttgateway%2Fmosquitto.log&header=html&format=template&only=once' target='_blank' data-inline='true' data-mini='true' data-icon='action'>Logfile</a></td>
				<td></td>
			</tr>
		</table>
	</div>
	<!-- /Form LOGS -->
</TMPL_IF>

<TMPL_UNLESS FORM_DISABLE_BUTTONS>

	<div style="display:flex;align-items:center;justify-content:center;">
	<button class="ui-btn ui-btn-icon-right" id="saveapply" data-inline="true">Save and Apply</button>
	<button class="ui-btn ui-btn-icon-right" id="restartmqttgateway" data-inline="true">Restart</button>
	</div>
	<div style="display:flex;align-items:center;justify-content:center;">
		<span id="savemessages"></span>&nbsp;
		<span id="savebrokerpass"></span>&nbsp;
		&nbsp;<span id="gatewaystate"></span>&nbsp;| 
		&nbsp;<span id="mosquittostate"></span>
	</div>

</TMPL_UNLESS>

	
<TMPL_UNLESS FORM_DISABLE_JS>

	<script>

	var cfg;
	var creds = { };
	var creds_changed = false;
	

	$(function() {
		
		setInterval(function(){ update_pids(); }, 5000);
		update_pids();
		
		// Parse config
		cfgstr = '<TMPL_VAR JSONCONFIG>';
		if (cfgstr) cfg = JSON.parse(cfgstr);
		extpluginsstr = '<TMPL_VAR EXTPLUGINSETTINGS>';
		if (extpluginsstr) extpluginsettings = JSON.parse(extpluginsstr);
		// console.log("Config", cfg, cfg.Main, cfg.subscriptions);
		
		// Hide donation
		if( cfg.Main.donation_remove === true )
			$("#coll_donate").hide();
		
		// View PurgeDB button if Mosquitto is managed by plugin
		if( is_enabled (cfg.Main.enable_mosquitto)  )
			$("#purgemosquittodb").show();
		
		// Elements in subscriptions
		if( cfg.subscriptions ) {
			var subscriptions = cfg.subscriptions;
			var subText = "";
			var toMS_delimiter = cfg.Main.toMS_delimiter;
			if ( toMS_delimiter == "" ) toMS_delimiter = "|";
			subscriptions.forEach( function(subObj){
				subText += subObj.id;
				if( subObj.toMS !== "undefined" && subObj.toMS.length > 0 ) {
					subText += toMS_delimiter + subObj.toMS.join(',');
				}
				subText += "\n";
			});
			
			// $("#subscriptions").text( cfg.subscriptions.join("\n") );
			$("#subscriptions").text( subText );
			validateTopics();
		}
		
		// Elements in conversions
		if( cfg.conversions )
			$("#conversions").text( cfg.conversions.join("\n") );
		
		// Elements in Main
		for(var elemname in cfg.Main) {
			var inputType = $("#Main\\."+elemname).attr('type');
			// console.log("Element", elemname, cfg.Main[elemname], inputType);
			if(inputType == "checkbox") {
				if( cfg.Main[elemname] == 1) 
					$("#Main\\."+elemname).prop('checked', true);
			} else {
				$("#Main\\."+elemname).val(cfg.Main[elemname]);
			}
		
		}
		$('select').selectmenu('refresh', true);
		$('input:checkbox').checkboxradio('refresh');
		
		// Set SecurePIN from session storage
		$('#securepin').val(sessionStorage.getItem("securePIN"));
		if( $('#securepin').val() ) {
			$('#check_securepin').trigger("click");
		}
		
		// Parse external plugin settings
		/* External Subscriptions and Conversions */
		extSubscriptionsHtml = "";
		extConversionsHtml = "";
		if( typeof extpluginsettings !== 'undefined' ) {
			$.each(extpluginsettings.plugins, function(pluginname, pluginobj) {
					// console.log("Plugin", pluginname, pluginobj);
					if(typeof pluginobj.subscriptions !== 'undefined' && pluginobj.subscriptions.length > 0) {
						extSubscriptionsHtml += '<div style="padding:10px 10px 10px 10px;">';
						extSubscriptionsHtml += '<b>'+pluginname+'</b>';
						extSubscriptionsHtml += '<div>'+pluginobj.subscriptions.join('</div><div>')+'</div>';
						extSubscriptionsHtml += '</div>';
					}
					if(typeof pluginobj.conversions !== 'undefined' && pluginobj.conversions.length > 0) {
						extConversionsHtml += '<div style="padding:10px 10px 10px 10px;">';
						extConversionsHtml += '<b>'+pluginname+'</b>';
						extConversionsHtml += '<div>'+pluginobj.conversions.join('</div><div>')+'</div>';
						extConversionsHtml += '</div>';
					}
			});
		}
		if(extSubscriptionsHtml) {
			// $("#extplugin_subscriptions_heading").html('<h4>Subscriptions defined by other plugins</h4>');
			// extSubscriptionsHtml = extSubscriptionsHtml;
			$("#extplugin_subscriptions").html(extSubscriptionsHtml);
			$("#coll_extsubscriptions").show();
		}
		if(extConversionsHtml) {
			// $("#extplugin_subscriptions_heading").html('<h4>Subscriptions defined by other plugins</h4>');
			// extSubscriptionsHtml = extSubscriptionsHtml;
			$("#extplugin_conversions").html(extConversionsHtml);
			$("#coll_extconversions").show();
		}
		
		
	});

	$('input, textarea, select').change(function(event) {
		$("#savemessages").attr("style", "color:blue").html("Unsaved changes |");

		var id = $(this).attr('id');
		var inputType = $(this).attr('type');
		// console.log(id, inputType, event);
			
		if (id == "subscriptions") {
			// Split lines by \n
			var subs = $.trim($("#"+id).val()).split("\n");
			
			var subscriptions = [];
			// Loop array, split every line by delimer
			subs.forEach( function(line){
				var toMS_delimiter = cfg.Main.toMS_delimiter;
				if( toMS_delimiter == "" ) toMS_delimiter = "|"; 
				var [topic, toMS] = line.split( toMS_delimiter, 2 );
				// Convert toMS string to array
				if( toMS ) {
					toMS = toMS.split(',');
				} else {
					toMS = [];
				}
				var subscription = { "id": topic, "toMS": toMS };
				subscriptions.push(subscription);
			});
			
			cfg.subscriptions = subscriptions;
			// console.log("Subscriptions Array", cfg.subscriptions);
		} 
		else if (id == "conversions") {
			// console.log("conversions content",  $("#"+id).val());
			cfg.conversions = $.trim($("#"+id).val()).split("\n");
			// console.log("Conversions Array", cfg.conversions);
		} 
		else if (id.startsWith("Main.")) {
			var idarray = id.split(".");
			if(inputType === "checkbox") {
				cfg.Main[idarray[1]] = $(this).is(":checked");
				if(id == "Main.enable_mosquitto") 
					creds_changed = true;
					if($(this).is(":checked")) 
						$("#brokerpsk_block").fadeIn();
					else
						$("#brokerpsk_block").fadeOut();
					
					
			} else {
				// console.log(idarray[0], idarray[1], $("#Main\\."+idarray[1]).val());
			
				cfg.Main[idarray[1]] = $(this).val();
			}
		}
		else if (id.startsWith("Credentials.")) {
			creds_changed = true;
			var idarray = id.split(".");
			if (!creds.Credentials) 
				creds.Credentials = [];
			creds.Credentials[idarray[1]] = $(this).val();
		}
	});


	$("#saveapply").click(function(){

		// var data = $('form').serialize() + "&save=true";
		// console.log("Submitting form", cfg);
		$("#saveapply").attr("disabled", true);
		$.ajax( { 
				type: 'POST',
				url: 'ajax_savejson.cgi', 
				dataType: 'json',
				contentType: 'text/plain; charset=UTF-8',
				data: JSON.stringify(cfg)
			} )
		.done(function() {
			// console.log( "Success" );
			$("#savemessages").attr("style", "color:green").html("Saved successfully |");
		})
		.fail(function() {
			// console.log( "Error" );
			$("#savemessages").attr("style", "color:red").html("Error saving |");
		})
		.always(function() {
			// console.log( "Finished" );
			$("#saveapply").attr("disabled", false);
		
		});
		if(creds_changed == true) {
			// Also save new credentials
			$.ajax( { 
					type: 'POST',
					url: 'ajax_brokercred.cgi', 
					//dataType: 'json',
					//contentType: 'text/plain; charset=UTF-8',
					data: { action: 'setcred', 
							secpin: $('#securepin').val(),
							brokeruser: creds.Credentials.brokeruser,
							brokerpass: creds.Credentials.brokerpass,
							enable_mosquitto: cfg.Main.enable_mosquitto}
				} )
			.fail(function( data ) {
				console.log( "Error saving credentials" );
				$("#savebrokerpass").attr("style", "color:red").html("Error saving credentials |");
			})
			.done(function( data ) {
				
				if( data.error != 0 ) {
					$("#savebrokerpass").attr("style", "color:red").html(data.message);
					return;
				}
				$("#savebrokerpass").attr("style", "color:green").html("Credentials saved successfully |");
			})
			
			.always(function( data ) {
				// console.log( "Credentials finished" );
			
			});
		
		}
	});

	$("#restartmqttgateway").click(function(){
		// console.log("Restart pressed");
		$("#restartmqttgateway").attr("disabled", true);
		
		
		// Depending if local Mosquitto or not, only restart Gateway or both
		if( is_enabled(cfg.Main.enable_mosquitto) === true)
			var action = 'mosquitto_restart';
		else 
			var action = 'restartgateway';
		
		$.post( 'index.cgi', {
			ajax: action })
		.done(function(resp) {
			// console.log( "ajax_post", "success", resp );
	  })
	  .fail(function(resp) {
			console.log( "ajax_post", "failed", resp );
	  })
	  .always(function(resp) {
			// console.log( "ajax_post", "finished", resp );
		$("#restartmqttgateway").attr("disabled", false);
		update_pids();
			
	  });
	});
	
	$("#purgemosquittodb").click(function(){
		// console.log("Restart Mosquitto database");
		$("#purgemosquittodb").attr("disabled", true);
		$.post( 'index.cgi', {
			ajax: 'mosquitto_purgedb' })
		.done(function(resp) {
			// console.log( "ajax_post", "success", resp );
	  })
	  .fail(function(resp) {
			console.log( "ajax_post", "failed", resp );
	  })
	  .always(function(resp) {
			// console.log( "ajax_post", "finished", resp );
		$("#purgemosquittodb").attr("disabled", false);
		update_pids();
			
	  });
	});

$("#reconnect").click(function(){
		// console.log("Reconnect and retransmit all values");
		$("#reconnect").attr("disabled", true);
		$.post( 'index.cgi', {
			ajax: 'reconnect',
			udpinport: cfg.Main.udpinport })
		.done(function(resp) {
			// console.log( "ajax_post", "success", resp );
	  })
	  .fail(function(resp) {
			console.log( "ajax_post", "failed", resp );
	  })
	  .always(function(resp) {
			// console.log( "ajax_post", "finished", resp );
		$("#reconnect").attr("disabled", false);
		update_pids();
			
	  });
	});



	$("#check_securepin").click(function(){

		// var data = $('form').serialize() + "&save=true";
		// console.log("Checking secure pin");
		$("#check_securepin").attr("disabled", true);
		$("#check_hint").attr("style", "color:blue;").html("One second...");
		$.ajax( { 
				type: 'POST',
				url: 'ajax_brokercred.cgi', 
				//dataType: 'json',
				//contentType: 'text/plain; charset=UTF-8',
				data: { action: 'getcred', secpin: $('#securepin').val() }
			} )
		.fail(function( data ) {
			console.log( "getcred Error" );
			$("#check_hint").attr("style", "color:red").html("Error checking your SecurePIN.");
		})
		.done(function( data ) {
			// console.log( "getcred Success" );
			// $("#savemessages").attr("style", "color:green").html("Saved successfully |");
			
			if( data.error != 0 ) {
				$("#check_hint").attr("style", "color:red").html(data.message);
				return;
			}
			$("#check_hint").attr("style", "color:green").html(data.message);
			// Save PIN to session storage
			sessionStorage.setItem("securePIN", $('#securepin').val());
			$("#securepin_block").fadeOut();
			//console.log("CredData", data);
			//console.log("user", data.Credentials.brokeruser);
			if(data.Credentials) {
				creds.Credentials = data.Credentials;
				if(data.Credentials.brokeruser) 
					$("#Credentials\\.brokeruser").val(data.Credentials.brokeruser);
				if(data.Credentials.brokerpass)
					$("#Credentials\\.brokerpass").val(data.Credentials.brokerpass);
				if(data.Credentials.brokerpsk)
					$("#Credentials\\.brokerpsk").val(data.Credentials.brokerpsk);

			}
			$("#credentials_block").fadeIn();
			if( $("#Main\\.enable_mosquitto").is(":checked") ) 
				$("#brokerpsk_block").fadeIn();
			else
				$("#brokerpsk_block").fadeOut();
			
			
		})
		
		.always(function( data ) {
			// console.log( "Finished" );
			$("#check_securepin").attr("disabled", false);
		
		});
		
	});


	
	function update_pids() 
	{

		$.post( 'index.cgi', {
			ajax: 'getpids' })
		.done(function(resp) {
			// console.log( "ajax_post", "success", resp );
			if(resp.pids.mqttgateway != null) {
				$("#gatewaystate").attr("style", "color:green").html("MQTT Gateway running (PID"+resp.pids.mqttgateway+")");
			} else {
				$("#gatewaystate").attr("style", "color:red").html("MQTT Gateway not running");
			}
			if(resp.pids.mosquitto != null) {
				$("#mosquittostate").attr("style", "color:green").html("Mosquitto running (PID"+resp.pids.mosquitto+")");
			} else {
				$("#mosquittostate").attr("style", "color:red").html("Mosquitto not running");
			}
			
	  })
	  .fail(function(resp) {
			$("#gatewaystate").attr("style", "color:red").html("Failed to query PIDs");
			$("#mosquittostate").attr("style", "color:red").html("Failed to query PIDs");
			
	  })
	  .always(function(resp) {
			// console.log( "ajax_post", "finished", resp );

		});
	}

	function pwRandomize()
	{
		// to implement
	
	}

	function validateTopic (topic) {
		// First remove the toMS part of the subscription
		var toMS_delimiter = cfg.Main.toMS_delimiter;
		if( toMS_delimiter == "" ) toMS_delimiter = "|"; 
		var [topic, toMS] = topic.split( toMS_delimiter, 2 );

		// Now check the topic only
		var parts = topic.split('/'),
		i = 0;

		for (i = 0; i < parts.length; i++) {
			if ('+' === parts[i]) {
				continue;
			}
			if ('#' === parts[i] ) {
				// for Rule #2
				return i === parts.length - 1;
			}

			if ( -1 !== parts[i].indexOf('+') || -1 !== parts[i].indexOf('#')) {
				return false;
			}
		}

		return true;
	}
	
	/*
		* Validate an array of topics to see if any of them is valid or not
		* @param {Array} topics - Array of topics
		* @returns {array} If all topics are valid, returns null. Otherwise, returns an array of all invalid ones
	*/
	function validateTopics (topics) {
		if ( $('#subscriptions').val() == null) return;
		var arrayOfTopics = $('#subscriptions').val().split('\n');
		var invalidTopics = [];
		for (var i = 0; i < arrayOfTopics.length; i++) {
			if ( !validateTopic(arrayOfTopics[i]) ) {
				invalidTopics.push(arrayOfTopics[i]);
			}
		}
		if(invalidTopics.length > 0) 
			$('#invalidTopics').html( 'The following topics have syntax errors:<br><b>'+invalidTopics.join('<br>')+'</b>' );
		else 
			$('#invalidTopics').html("");
		
	}
	
	/* Directly validate the topics during input */
	$('#subscriptions').on('input', function() { 
		validateTopics();
	});

	/* A simple is_enabled function as known from LoxBerry's Perl and PHP SDK */
	function is_enabled( checkVal ) 
	{
		// console.log("is_enabled", checkVal);
		if( typeof checkVal === 'undefined' ) return false;
		
		checkVal = checkVal.toString();
		
		enabled = [ true, "true", 1, "1", "on", "yes", "enable", "enabled", "select", "selected", "checked" ];
		checkVal = checkVal.trim().toLowerCase();
		return enabled.includes(checkVal);
	}

	/*	Returns a value from a nested object without exception if undefined
		get( response, 'health_state.httpresp' */
	get = function(obj, key) {
    return key.split(".").reduce(function(o, x) {
        return (typeof o == "undefined" || o === null) ? o : o[x];
    }, obj);
}
	
	</script>

</TMPL_UNLESS>