<style>
.mono {
	font-family:monospace;
	font-size:110%;
	font-weight:bold;
	color:green;

}
#overlay 
{
  display: none !important;
}
</style>
<form id="form" onsubmit="return false;">
<div class="wide">MQTT to Miniserver</div>
<br>

<div data-role="fieldcontain">
	<label for="subscriptions">MQTT subscriptions</label>
	<textarea name="subscriptions" id="subscriptions"></textarea>
	<p class="hint">One subscription topic per line. For Shelly devices, use <span class="mono">shellies/#</span></p>
</div>

<div data-role="fieldcontain">
	<fieldset data-role="controlgroup">
		<legend>Type sending the data to Miniserver</legend>
		<input type="checkbox" name="Main.use_http" id="Main.use_http">
		<label for="Main.use_http">Set virtual inputs via HTTP webservice (recommended)</label>
		<input type="checkbox" name="Main.use_udp" id="Main.use_udp">
		<label for="Main.use_udp">Send data via UDP</label>
		<p class="hint">See the Wiki for details how to configure your inputs on your Miniserver.</p>
	</fieldset>
	
<div>

<div data-role="fieldcontain">
	<!-- <label for="Main.msno">Miniserver to relay to</label> -->
	<TMPL_VAR mslist_select_html>
</div>

<div data-role="fieldcontain">
	<label for="Main.udpport">Miniserver UDP port</label>
	<input name="Main.udpport" id="Main.udpport" type="text" />
	<p class="hint">Default UDP port is 11883</p>
</div>

<fieldset data-role="controlgroup">
	<legend>Data transformations</legend>
	<input type="checkbox" name="Main.convert_booleans" id="Main.convert_booleans">
	<label for="Main.convert_booleans">Convert booleans to 1 and 0</label>
</fieldset>

<br>
<div class="wide">Miniserver to MQTT</div>
<br>

<div data-role="fieldcontain">
	<label for="Main.udpinport">Gateway UDP in-port</label>
	<input name="Main.udpinport" id="Main.udpinport" type="text" />
	<p class="hint">Default UDP IN-port on LoxBerry is 11883</p>
</div>

<br>
<div class="wide">MQTT Broker</div>
<br>
<fieldset data-role="controlgroup">
	<legend>Use local Mosquitto broker</legend>
	<input type="checkbox" name="Main.enable_mosquitto" id="Main.enable_mosquitto">
	<label for="Main.enable_mosquitto">Use the local Mosquitto MQTT broker (default: enabled)</label>
</fieldset>

<div data-role="fieldcontain">
	<label for="Main.brokeraddress">MQTT Broker address</label>
	<input name="Main.brokeraddress" id="Main.brokeraddress" type="text" />
	<p class="hint">Default is <span class="mono">localhost</span> for the local Mosquitto installation. Experienced users may use a remote MQTT broker.</p>
</div>

<div data-role="fieldcontain">
	<label for="Main.brokeruser">MQTT Broker username</label>
	<input name="Main.brokeruser" id="Main.brokeruser" type="text" />
	<p class="hint">Default is empty (no authentication) for the local Mosquitto installation.</p>
</div>

<div data-role="fieldcontain">
	<label for="Main.brokerpass">MQTT Broker password</label>
	<input name="Main.brokerpass" id="Main.brokerpass" type="text" />
	<p class="hint">Default is empty (no authentication) for the local Mosquitto installation.</p>
</div>

<div style="display:flex;align-items:center;justify-content:center;">
<button class="ui-btn ui-btn-icon-right" id="saveapply" data-inline="true">Save and Apply</button>
<button class="ui-btn ui-btn-icon-right" id="restartmqttgateway" data-inline="true">Restart</button>
</div>
<div style="display:flex;align-items:center;justify-content:center;">
	<span id="savemessages"></span>&nbsp;
	&nbsp;<span id="gatewaystate"></span>&nbsp;| 
	&nbsp;<span id="mosquittostate"></span>
</div>
</form>

<script>

var cfg;


$(function() {
	
	setInterval(function(){ update_pids(); }, 5000);
	update_pids();
	
	cfg = JSON.parse('<TMPL_VAR JSONCONFIG>');
	console.log("Config", cfg, cfg.Main, cfg.subscriptions);
	
	// Elements in subscriptions
	$("#subscriptions").text( cfg.subscriptions.join("\n") );
	
	// Elements in Main
	for(var elemname in cfg.Main) {
		var inputType = $("#Main\\."+elemname).attr('type');
		console.log("Element", elemname, cfg.Main[elemname], inputType);
		if(inputType == "checkbox" && cfg.Main[elemname] == 1) {
			$("#Main\\."+elemname).prop('checked', true);
		} else {
			$("#Main\\."+elemname).val(cfg.Main[elemname]);
		}
	}
	$('select').selectmenu('refresh', true);
	$('input:checkbox').checkboxradio('refresh');
	
});

$('input, textarea, select').change(function(event) {
	$("#savemessages").attr("style", "color:blue").html("Unsaved changes |");

	var id = $(this).attr('id');
	var inputType = $(this).attr('type');
	console.log(id, inputType, event);
		
	if (id == "subscriptions") {
		console.log("subscritions content",  $("#"+id).val());
		cfg.subscriptions = $.trim($("#"+id).val()).split("\n");
		console.log("Subscriptions Array", cfg.subscriptions);
	} else if (id.startsWith("Main.")) {
		var idarray = id.split(".");
		if(inputType === "checkbox") {
			cfg.Main[idarray[1]] = $(this).is(":checked");
		} else {
			// console.log(idarray[0], idarray[1], $("#Main\\."+idarray[1]).val());
		
			cfg.Main[idarray[1]] = $(this).val();
		}
	}



});


$("#saveapply").click(function(){

	// var data = $('form').serialize() + "&save=true";
	console.log("Submitting form", cfg);
	$("#saveapply").attr("disabled", true);
	$.ajax( { 
			type: 'POST',
			url: 'ajax.cgi', 
			dataType: 'json',
			contentType: 'text/plain; charset=UTF-8',
			data: JSON.stringify(cfg)
		} )
	.done(function() {
		console.log( "Success" );
		$("#savemessages").attr("style", "color:green").html("Saved successfully |");
	})
	.fail(function() {
		console.log( "Error" );
		$("#savemessages").attr("style", "color:red").html("Error saving |");
	})
	.always(function() {
		console.log( "Finished" );
		$("#saveapply").attr("disabled", false);
	
	});
	
});

$("#restartmqttgateway").click(function(){
	console.log("Restart pressed");
	$("#restartmqttgateway").attr("disabled", true);
	$.post( 'index.cgi', {
		ajax: 'restartgateway' })
	.done(function(resp) {
		console.log( "ajax_post", "success", resp );
  })
  .fail(function(resp) {
		console.log( "ajax_post", "failed", resp );
  })
  .always(function(resp) {
		console.log( "ajax_post", "finished", resp );
	$("#restartmqttgateway").attr("disabled", false);
	update_pids();
		
  });
});

function update_pids() 
{

	$.post( 'index.cgi', {
		ajax: 'getpids' })
	.done(function(resp) {
		// console.log( "ajax_post", "success", resp );
		if(resp.pids.mqttgateway != null) {
			$("#gatewaystate").attr("style", "color:green").html("MQTT Gateway running (PID"+resp.pids.mqttgateway+")");
		} else {
			$("#gatewaystate").attr("style", "color:red").html("MQTT Gateway not running");
		}
		if(resp.pids.mosquitto != null) {
			$("#mosquittostate").attr("style", "color:green").html("Mosquitto running (PID"+resp.pids.mosquitto+")");
		} else {
			$("#mosquittostate").attr("style", "color:red").html("Mosquitto not running");
		}
		
  })
  .fail(function(resp) {
		$("#gatewaystate").attr("style", "color:red").html("Failed to query PIDs");
		$("#mosquittostate").attr("style", "color:red").html("Failed to query PIDs");
		
  })
  .always(function(resp) {
		// console.log( "ajax_post", "finished", resp );

	});
}


</script>
